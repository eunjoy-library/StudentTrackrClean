from flask import Flask, render_template_string, request, redirect, url_for, flash, send_file, session
from datetime import datetime, timedelta
import pandas as pd
import csv
import os

app = Flask(__name__)
app.secret_key = 'secret_key'

FILENAME = 'attendance.csv'
BACKUP_FILE = 'attendance_backup.csv'
LOG_FILE = 'attendance_error.log'
EXCEL_FRIENDLY_FILE = 'attendance_excel.csv'
STUDENT_FILE = 'students.xlsx'
ADMIN_PASSWORD = 'admin1234'  # ê´€ë¦¬ììš© ë¹„ë°€ë²ˆí˜¸

def load_student_data():
    try:
        df = pd.read_excel(STUDENT_FILE, dtype={'í•™ë²ˆ': str})
        return {row['í•™ë²ˆ'].strip(): (row['ì´ë¦„'].strip(), row['ê³µê°•ì¢Œì„ë²ˆí˜¸']) for _, row in df.iterrows()}
    except Exception as e:
        print(f"[ì˜¤ë¥˜] í•™ìƒ ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤: {e}")
        return {}

def check_attendance(student_id):
    if student_id.startswith('3'):
        return False
    if not os.path.exists(FILENAME):
        return False
    with open(FILENAME, newline='', encoding='utf-8') as f:
        reader = csv.DictReader(f)
        one_week_ago = datetime.now() - timedelta(days=7)
        for r in reader:
            if r['í•™ë²ˆ'] == student_id:
                try:
                    attend_time = datetime.strptime(r['ì¶œì„ì¼'], '%Y-%m-%d %H:%M:%S')
                except ValueError:
                    try:
                        attend_time = datetime.strptime(r['ì¶œì„ì¼'], '%Y-%m-%d')
                    except ValueError:
                        continue
                if attend_time >= one_week_ago:
                    return True
        return False

def load_attendance():
    if not os.path.exists(FILENAME):
        return []
    with open(FILENAME, newline='', encoding='utf-8') as f:
        return list(csv.DictReader(f))

def save_attendance(student_id, name, seat):
    file_exists = os.path.exists(FILENAME)
    now = datetime.now().strftime('%Y-%m-%d %H:%M:%S')
    row = {'ì¶œì„ì¼': now, 'í•™ë²ˆ': student_id, 'ì´ë¦„': name, 'ê³µê°•ì¢Œì„ë²ˆí˜¸': seat}

    try:
        with open(FILENAME, 'a', newline='', encoding='utf-8') as f:
            fieldnames = ['ì¶œì„ì¼', 'í•™ë²ˆ', 'ì´ë¦„', 'ê³µê°•ì¢Œì„ë²ˆí˜¸']
            writer = csv.DictWriter(f, fieldnames=fieldnames, quoting=csv.QUOTE_ALL)
            if not file_exists:
                writer.writeheader()
            writer.writerow(row)

        with open(BACKUP_FILE, 'a', newline='', encoding='utf-8') as backup:
            backup_writer = csv.DictWriter(backup, fieldnames=fieldnames, quoting=csv.QUOTE_ALL)
            if not os.path.exists(BACKUP_FILE):
                backup_writer.writeheader()
            backup_writer.writerow(row)

        with open(EXCEL_FRIENDLY_FILE, 'a', newline='', encoding='cp949') as excel_file:
            excel_writer = csv.DictWriter(excel_file, fieldnames=fieldnames, quoting=csv.QUOTE_ALL)
            if not os.path.exists(EXCEL_FRIENDLY_FILE):
                excel_writer.writeheader()
            excel_writer.writerow(row)

    except PermissionError:
        error_msg = f"[{datetime.now()}] PermissionError: Could not write to {FILENAME}\n"
        with open(LOG_FILE, 'a', encoding='utf-8') as log:
            log.write(error_msg)
        flash("âš ï¸ ì¶œì„ íŒŒì¼ì´ ì—´ë ¤ ìˆì–´ ì €ì¥í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤. Excel íŒŒì¼ì„ ë‹«ê³  ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.")

template = '''<html><head><meta charset="UTF-8"><title>ë„ì„œì‹¤ ì¶œì„</title></head><body><h1>ğŸ“š ë„ì„œì‹¤ ì¶œì„ì²´í¬</h1><form method="post"><input type="text" name="student_id" placeholder="í•™ë²ˆ" required><input type="text" name="name" placeholder="ì´ë¦„" required><button type="submit">ì¶œì„í•˜ê¸°</button></form>{% with messages = get_flashed_messages() %}{% if messages %}<div>{{ messages[0] }}</div>{% endif %}{% endwith %}<br><a href="/admin">ê´€ë¦¬ì ëª¨ë“œ</a></body></html>'''

list_template = '''<html><head><meta charset="UTF-8"><title>ì¶œì„ ëª…ë‹¨</title>
<script>
function searchTable() {
    var input, filter, table, tr, td, i, txtValue;
    input = document.getElementById("searchInput");
    filter = input.value.toUpperCase();
    table = document.getElementById("attendanceTable");
    tr = table.getElementsByTagName("tr");
    for (i = 1; i < tr.length; i++) {
        tr[i].style.display = "none";
        td_array = tr[i].getElementsByTagName("td");
        for (var j = 0; j < td_array.length; j++) {
            td = td_array[j];
            if (td) {
                txtValue = td.textContent || td.innerText;
                if (txtValue.toUpperCase().indexOf(filter) > -1) {
                    tr[i].style.display = "";
                    break;
                }
            }
        }
    }
}
</script>
</head><body><h1>ğŸ“‹ ì¶œì„ ëª…ë‹¨</h1>
<input type="text" id="searchInput" onkeyup="searchTable()" placeholder="ê²€ìƒ‰ì–´ ì…ë ¥">
<table id="attendanceTable" border="1"><thead><tr><th>ì¶œì„ì¼</th><th>í•™ë²ˆ</th><th>ì´ë¦„</th><th>ê³µê°•ì¢Œì„ë²ˆí˜¸</th></tr></thead><tbody>{% for r in records %}<tr><td>{{ r['ì¶œì„ì¼'] }}</td><td>{{ r['í•™ë²ˆ'] }}</td><td>{{ r['ì´ë¦„'] }}</td><td>{{ r['ê³µê°•ì¢Œì„ë²ˆí˜¸'] }}</td></tr>{% endfor %}</tbody></table><br><a href="/export">CSV ë‹¤ìš´ë¡œë“œ</a> | <a href="/print">ì¶œì„ ì¶œë ¥</a> | <a href="/stats">ì¶œì„ í†µê³„</a> | <a href="/">ë©”ì¸</a></body></html>'''

@app.route('/', methods=['GET', 'POST'])
def attendance():
    student_data = load_student_data()
    if request.method == 'POST':
        student_id = request.form['student_id'].strip()
        name = request.form['name'].strip()

        student_info = student_data.get(student_id)

        if student_info is None:
            flash("âŒ í•™ë²ˆì´ ì˜¬ë°”ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤. ë‹¤ì‹œ í™•ì¸í•´ì£¼ì„¸ìš”.")
        elif student_info[0].replace(' ', '') != name.replace(' ', ''):
            flash(f"âŒ ì…ë ¥í•œ ì´ë¦„ì´ í•™ë²ˆê³¼ ì¼ì¹˜í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤. ì…ë ¥í•œ ì´ë¦„: {name}, ì €ì¥ëœ ì´ë¦„: {student_info[0]}")
        elif check_attendance(student_id):
            flash("âš ï¸ ì´ë²ˆ ì£¼ì— ì´ë¯¸ ì¶œì„í•˜ì…¨ìŠµë‹ˆë‹¤. ë‹¤ìŒ ì£¼ì— ë‹¤ì‹œ ì™€ì£¼ì„¸ìš”.")
        else:
            seat = student_info[1]
            save_attendance(student_id, name, seat)
            flash(f"âœ… ì¶œì„ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤. ê³µê°•ì¢Œì„ë²ˆí˜¸: {seat}")
        return redirect(url_for('attendance'))
    return render_template_string(template)

@app.route('/admin', methods=['GET', 'POST'])
def admin_login():
    if request.method == 'POST':
        password = request.form.get('password')
        if password == ADMIN_PASSWORD:
            session['admin'] = True
            return redirect('/list')
        else:
            flash('âŒ ë¹„ë°€ë²ˆí˜¸ê°€ í‹€ë ¸ìŠµë‹ˆë‹¤.')
    return '''<form method="post"><input type="password" name="password" placeholder="ê´€ë¦¬ì ë¹„ë°€ë²ˆí˜¸"><button type="submit">í™•ì¸</button></form>'''

@app.route('/list')
def list_attendance():
    if not session.get('admin'):
        return redirect('/admin')
    records = sorted(load_attendance(), key=lambda x: (x['ì¶œì„ì¼'], x['í•™ë²ˆ']))
    return render_template_string(list_template, records=records)

@app.route('/export')
def export_csv():
    return send_file(FILENAME, as_attachment=True)

@app.route('/print')
def print_view():
    records = load_attendance()
    html = '<html><head><meta charset="utf-8"><title>ì¶œì„ ì¶œë ¥</title></head><body>'
    html += '<h2>ì¶œì„ ëª…ë‹¨</h2><table border="1" cellspacing="0" cellpadding="5">'
    html += '<tr><th>ì¶œì„ì¼</th><th>í•™ë²ˆ</th><th>ì´ë¦„</th><th>ê³µê°•ì¢Œì„ë²ˆí˜¸</th></tr>'
    for r in records:
        html += f"<tr><td>{r['ì¶œì„ì¼']}</td><td>{r['í•™ë²ˆ']}</td><td>{r['ì´ë¦„']}</td><td>{r['ê³µê°•ì¢Œì„ë²ˆí˜¸']}</td></tr>"
    html += '</table></body></html>'
    return html

@app.route('/stats')
def stats():
    from collections import Counter
    records = load_attendance()
    counts = Counter(r['ì´ë¦„'] for r in records)
    html = '<h2>ì¶œì„ í†µê³„</h2><ul>'
    for name, count in counts.items():
        html += f"<li>{name}: {count}íšŒ</li>"
    html += '</ul><a href="/list">â† ëª…ë‹¨ìœ¼ë¡œ ëŒì•„ê°€ê¸°</a>'
    return html

if __name__ == '__main__':
    app.run(host='0.0.0.0', port=5000, debug=True)
