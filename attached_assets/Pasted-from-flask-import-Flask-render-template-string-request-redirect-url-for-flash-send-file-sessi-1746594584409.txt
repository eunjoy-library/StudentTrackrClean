from flask import Flask, render_template_string, request, redirect, url_for, flash, send_file, session
from datetime import datetime, timedelta
import pandas as pd
import csv
import os

app = Flask(__name__)
app.secret_key = 'secret_key'

FILENAME = 'attendance.csv'
BACKUP_FILE = 'attendance_backup.csv'
LOG_FILE = 'attendance_error.log'
EXCEL_FRIENDLY_FILE = 'attendance_excel.csv'
STUDENT_FILE = 'students.xlsx'
ADMIN_PASSWORD = 'admin1234'  # ê´€ë¦¬ììš© ë¹„ë°€ë²ˆí˜¸

PERIOD_SCHEDULE = {
    1: (8, 0, 9, 15),
    2: (9, 15, 10, 30),
    3: (10, 30, 11, 45),
    4: (11, 45, 13, 0),
    5: (13, 0, 14, 15),
    6: (14, 15, 15, 30),
    7: (15, 30, 16, 45),
    8: (16, 45, 18, 0),
    9: (18, 0, 19, 15),
    10: (19, 15, 20, 30)
}

def get_current_period():
    now = datetime.now().time()
    for period, (start_h, start_m, end_h, end_m) in PERIOD_SCHEDULE.items():
        start = datetime.strptime(f"{start_h}:{start_m}", "%H:%M").time()
        end = datetime.strptime(f"{end_h}:{end_m}", "%H:%M").time()
        if start <= now < end:
            return period
    return 0  # êµì‹œê°€ ì•„ë‹Œ ì‹œê°„ì¼ ê²½ìš°

def load_student_data():
    try:
        df = pd.read_excel(STUDENT_FILE, dtype={'í•™ë²ˆ': str})
        return {row['í•™ë²ˆ'].strip(): (row['ì´ë¦„'].strip(), row['ê³µê°•ì¢Œì„ë²ˆí˜¸']) for _, row in df.iterrows()}
    except Exception as e:
        print(f"[ì˜¤ë¥˜] í•™ìƒ ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤: {e}")
        return {}

def check_attendance(student_id):
    if student_id.startswith('3'):
        return False
    if not os.path.exists(FILENAME):
        return False
    with open(FILENAME, newline='', encoding='utf-8') as f:
        reader = csv.DictReader(f)
        one_week_ago = datetime.now() - timedelta(days=7)
        for r in reader:
            if r['í•™ë²ˆ'] == student_id:
                try:
                    attend_time = datetime.strptime(r['ì¶œì„ì¼'], '%Y-%m-%d %H:%M:%S')
                except ValueError:
                    try:
                        attend_time = datetime.strptime(r['ì¶œì„ì¼'], '%Y-%m-%d')
                    except ValueError:
                        continue
                if attend_time >= one_week_ago:
                    return True
        return False

def load_attendance():
    if not os.path.exists(FILENAME):
        return []
    with open(FILENAME, newline='', encoding='utf-8') as f:
        return list(csv.DictReader(f))

def save_attendance(student_id, name, seat):
    file_exists = os.path.exists(FILENAME)
    now = datetime.now().strftime('%Y-%m-%d %H:%M:%S')
    period = get_current_period()
    row = {'ì¶œì„ì¼': now, 'êµì‹œ': f'{period}êµì‹œ' if period > 0 else 'ì‹œê°„ ì™¸', 'í•™ë²ˆ': student_id, 'ì´ë¦„': name, 'ê³µê°•ì¢Œì„ë²ˆí˜¸': seat}

    try:
        fieldnames = ['ì¶œì„ì¼', 'êµì‹œ', 'í•™ë²ˆ', 'ì´ë¦„', 'ê³µê°•ì¢Œì„ë²ˆí˜¸']

        with open(FILENAME, 'a', newline='', encoding='utf-8') as f:
            writer = csv.DictWriter(f, fieldnames=fieldnames, quoting=csv.QUOTE_ALL)
            if not file_exists:
                writer.writeheader()
            writer.writerow(row)

        with open(BACKUP_FILE, 'a', newline='', encoding='utf-8') as backup:
            backup_writer = csv.DictWriter(backup, fieldnames=fieldnames, quoting=csv.QUOTE_ALL)
            if not os.path.exists(BACKUP_FILE):
                backup_writer.writeheader()
            backup_writer.writerow(row)

        with open(EXCEL_FRIENDLY_FILE, 'a', newline='', encoding='cp949') as excel_file:
            excel_writer = csv.DictWriter(excel_file, fieldnames=fieldnames, quoting=csv.QUOTE_ALL)
            if not os.path.exists(EXCEL_FRIENDLY_FILE):
                excel_writer.writeheader()
            excel_writer.writerow(row)

    except PermissionError:
        error_msg = f"[{datetime.now()}] PermissionError: Could not write to {FILENAME}\n"
        with open(LOG_FILE, 'a', encoding='utf-8') as log:
            log.write(error_msg)
        flash("âš ï¸ ì¶œì„ íŒŒì¼ì´ ì—´ë ¤ ìˆì–´ ì €ì¥í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤. Excel íŒŒì¼ì„ ë‹«ê³  ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.")

template = '''<html><head><meta charset="UTF-8"><title>ë„ì„œì‹¤ ì¶œì„</title>
<style>
body {
    background-color: #121212;
    color: #f0f0f0;
    font-family: 'Arial';
    padding: 30px;
    text-align: center;
}
input, button {
    background-color: #1e1e1e;
    color: #f0f0f0;
    border: 1px solid #444;
    padding: 10px;
    margin: 10px;
    border-radius: 6px;
}
button:hover {
    background-color: #2d89ef;
    color: white;
}
a {
    color: #90caf9;
    text-decoration: none;
}
</style>
<script>
function updateButtonLabel() {
    const now = new Date();
    const month = now.getMonth() + 1;
    const day = now.getDate();
    const hour = now.getHours();
    const minute = now.getMinutes();

    let period = 'ì‹œê°„ ì™¸';
    const schedule = [
        [8, 0, 9, 15], [9, 15, 10, 30], [10, 30, 11, 45], [11, 45, 13, 0],
        [13, 0, 14, 15], [14, 15, 15, 30], [15, 30, 16, 45], [16, 45, 18, 0],
        [18, 0, 19, 15], [19, 15, 20, 30]
    ];
    for (let i = 0; i < schedule.length; i++) {
        const [sh, sm, eh, em] = schedule[i];
        const start = new Date(); start.setHours(sh, sm);
        const end = new Date(); end.setHours(eh, em);
        const current = new Date(); current.setHours(hour, minute);
        if (current >= start && current < end) {
            period = (i + 1) + 'êµì‹œ';
            break;
        }
    }
    document.getElementById("submitBtn").textContent = `${month}ì›” ${day}ì¼ ${period} ì¶œì„í•˜ê¸°`;
}
setInterval(updateButtonLabel, 1000);
</script>
</head><body onload="updateButtonLabel()">
<h1>ğŸ“š ë„ì„œì‹¤ ì¶œì„ì²´í¬</h1>
<form method="post">
<input type="text" name="student_id" placeholder="í•™ë²ˆ" required>
<input type="text" name="name" placeholder="ì´ë¦„" required>
<button type="submit" id="submitBtn">ì¶œì„í•˜ê¸°</button>
</form>
{% with messages = get_flashed_messages() %}{% if messages %}<div>{{ messages[0] }}</div>{% endif %}{% endwith %}<br><a href="/admin">ê´€ë¦¬ì ëª¨ë“œ</a></body></html>'''
