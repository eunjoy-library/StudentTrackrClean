{% extends "layout.html" %}

{% block title %}학생 출석{% endblock %}

{% block head_extra %}
<!-- 오디오 기능은 layout.html에서 관리됩니다 -->
<script>
    // 오디오 변수는 layout.html에서 정의되어 있습니다
</script>
{% endblock %}

{% block content %}
<div class="container">
    <div class="row justify-content-center">
        <div class="col-md-8">
            <div class="card shadow-lg">
                <div class="card-header bg-dark text-white">
                    <h2 class="text-center mb-0">도서실 출석 체크</h2>
                </div>
                <div class="card-body">
                    <p class="text-center mb-4 fs-5">
                        <strong>{{ today }}</strong> ({{ day_of_week }})
                        <br>
                        {% if current_period_number == 0 %}
                        <span class="badge bg-warning text-dark">4교시는 도서실 이용 시간이 아닙니다</span>
                        {% elif current_period_number == -1 %}
                        <span class="badge bg-secondary">시간외</span>
                        {% else %}
                        <span class="badge bg-primary">{{ current_period }}</span>
                        {% endif %}
                    </p>

                    <form id="attendance-form" method="post" class="needs-validation" novalidate>
                        <div class="mb-4">
                            <div class="form-group">
                                <label for="student_id" class="form-label">학생 번호</label>
                                <input type="text" class="form-control form-control-lg" id="student_id" name="student_id" 
                                       placeholder="학생번호를 입력하세요" pattern="[0-9]+" required autofocus>
                                <div class="invalid-feedback">
                                    올바른 학생 번호를 입력해주세요.
                                </div>
                            </div>
                        </div>

                        <div class="mb-4">
                            <div class="form-group">
                                <label for="name" class="form-label">이름</label>
                                <input type="text" class="form-control form-control-lg" id="name" name="name" 
                                       placeholder="이름이 자동으로 표시됩니다" readonly>
                            </div>
                        </div>

                        <div class="mb-4">
                            <div class="form-group">
                                <label for="seat" class="form-label">자리 번호</label>
                                <input type="text" class="form-control form-control-lg" id="seat" name="seat" 
                                       placeholder="자리 번호가 자동으로 표시됩니다" readonly>
                            </div>
                        </div>

                        <div class="d-grid gap-2">
                            <button type="submit" class="btn btn-primary btn-lg" id="submit-btn">출석 등록</button>
                            <button type="button" class="btn btn-secondary btn-lg" onclick="resetForm()">초기화</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- 모달 대화상자 -->
<div class="modal fade" id="resultModal" tabindex="-1" aria-labelledby="resultModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="resultModalLabel">출석 결과</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body" id="modal-message">
                처리 중...
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-primary" data-bs-dismiss="modal" id="modal-confirm-btn">확인</button>
            </div>
        </div>
    </div>
</div>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        const studentIdInput = document.getElementById('student_id');
        const nameInput = document.getElementById('name');
        const seatInput = document.getElementById('seat');
        const attendanceForm = document.getElementById('attendance-form');
        const submitBtn = document.getElementById('submit-btn');
        const modalConfirmBtn = document.getElementById('modal-confirm-btn');
        const resultModal = new bootstrap.Modal(document.getElementById('resultModal'));
        const modalMessage = document.getElementById('modal-message');

        let hasCheckedAttendance = false;
        
        // ID 입력시 이름과 좌석 자동 조회
        studentIdInput.addEventListener('input', function() {
            // 3자리 이상 입력시에만 조회
            if (this.value.length >= 3) {
                nameInput.value = "조회 중...";
                seatInput.value = "조회 중...";
                
                fetch('/lookup_name?student_id=' + this.value)
                    .then(response => response.json())
                    .then(data => {
                        if (data.name) {
                            nameInput.value = data.name;
                            seatInput.value = data.seat || "지정 좌석 없음";
                            hasCheckedAttendance = false;
                        } else {
                            nameInput.value = "학생 정보 없음";
                            seatInput.value = "";
                        }
                    })
                    .catch(error => {
                        console.error('Error:', error);
                        nameInput.value = "조회 오류";
                        seatInput.value = "";
                    });
            } else {
                nameInput.value = "";
                seatInput.value = "";
                hasCheckedAttendance = false;
            }
        });

        // 출석 전 API로 출석 가능 여부 확인
        attendanceForm.addEventListener('submit', function(event) {
            event.preventDefault();
            
            if (!studentIdInput.value) {
                modalMessage.innerHTML = "학생 번호를 입력해주세요.";
                resultModal.show();
                return;
            }
            
            if (nameInput.value === "학생 정보 없음" || nameInput.value === "조회 오류" || !nameInput.value) {
                modalMessage.innerHTML = "유효한 학생 정보가 없습니다.";
                resultModal.show();
                return;
            }
            
            // 중복 출석 확인 API 호출
            fetch('/api/check_attendance?student_id=' + studentIdInput.value)
                .then(response => response.json())
                .then(data => {
                    console.log("학생 출석 상태 확인:", data);
                    
                    if (data.has_attendance) {
                        // 이미 출석한 경우
                        modalMessage.innerHTML = `<div class="alert alert-warning">
                            <h5>이번주에 이미 출석하셨습니다. 4층 공강실로 올라가주세요~!</h5>
                            <p>이전 출석일: ${data.formatted_date}</p>
                        </div>`;
                        modalConfirmBtn.disabled = true;
                        resultModal.show();
                    } else if (data.is_warned) {
                        // 경고를 받은 학생
                        modalMessage.innerHTML = `<div class="alert alert-danger">
                            <h5>출석이 제한된 학생입니다.</h5>
                            <p>사유: ${data.warning_reason}</p>
                            <p>해제일: ${data.warning_until}</p>
                        </div>`;
                        modalConfirmBtn.disabled = true;
                        resultModal.show();
                    } else {
                        // 출석 가능한 경우 폼 제출
                        submitAttendance();
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    modalMessage.innerHTML = "출석 상태 확인 중 오류가 발생했습니다.";
                    resultModal.show();
                });
        });
        
        // 실제 출석 처리 함수
        function submitAttendance() {
            const formData = new FormData(attendanceForm);
            
            fetch('/', {
                method: 'POST',
                body: formData
            })
            .then(response => response.text())
            .then(html => {
                // 성공 여부 확인 (간단한 문자열 체크)
                if (html.includes("success") || html.includes("출석이 완료되었습니다")) {
                    modalMessage.innerHTML = `<div class="alert alert-success">
                        <h4>출석이 완료되었습니다!</h4>
                        <p>${nameInput.value} 학생 (${studentIdInput.value}번)</p>
                        <p>자리: ${seatInput.value}</p>
                    </div>`;
                    modalConfirmBtn.disabled = false;
                    
                    // 성공 오디오 재생
                    try {
                        new Audio(successAudioBase64).play().catch(e => console.error('성공 오디오 재생 오류:', e));
                    } catch (e) {
                        console.error('성공 오디오 재생 오류:', e);
                    }
                    
                    // 폼 초기화
                    resetForm();
                } else {
                    let errorMsg = "알 수 없는 오류가 발생했습니다.";
                    
                    if (html.includes("maximum students")) {
                        errorMsg = "현재 교시 최대 인원을 초과했습니다.";
                    } else if (html.includes("not allowed")) {
                        errorMsg = "현재 교시에는 출석이 제한되어 있습니다.";
                    }
                    
                    modalMessage.innerHTML = `<div class="alert alert-danger">${errorMsg}</div>`;
                    modalConfirmBtn.disabled = false;
                    
                    // 실패 오디오 재생
                    try {
                        new Audio(errorAudioBase64).play().catch(e => console.error('실패 오디오 재생 오류:', e));
                    } catch (e) {
                        console.error('실패 오디오 재생 오류:', e);
                    }
                }
                
                resultModal.show();
            })
            .catch(error => {
                console.error('Error:', error);
                modalMessage.innerHTML = "서버 오류가 발생했습니다.";
                modalConfirmBtn.disabled = false;
                resultModal.show();
            });
        }
        
        // 모달 닫을 때 포커스 처리
        modalConfirmBtn.addEventListener('click', function() {
            studentIdInput.focus();
        });

        // 모달 닫힌 후 포커스 처리
        document.getElementById('resultModal').addEventListener('hidden.bs.modal', function() {
            modalConfirmBtn.disabled = false;
            studentIdInput.focus();
        });
    });
    
    // 폼 초기화 함수
    function resetForm() {
        document.getElementById('student_id').value = '';
        document.getElementById('name').value = '';
        document.getElementById('seat').value = '';
        document.getElementById('student_id').focus();
    }
    
    // 키보드 단축키: Ctrl+F = 학생 번호 입력 필드에 포커스
    document.addEventListener('keydown', function(event) {
        if (event.ctrlKey && event.key === 'f') {
            event.preventDefault();
            document.getElementById('student_id').focus();
        }
    });
</script>
{% endblock %}