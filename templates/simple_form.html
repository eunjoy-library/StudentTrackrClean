{% extends "layout.html" %}

{% block title %}학생 출석{% endblock %}

{% block head_extra %}
<!-- 오디오 기능은 layout.html에서 정의되어 있습니다 -->
<script>
    // 레이아웃 템플릿에서 정의된 오디오 변수를 사용합니다
</script>
{% endblock %}

{% block content %}
<div class="container main-container mt-4">
    <div class="card text-center shadow attendance-card">
        <div class="card-header text-center py-3 attendance-header">
            <div id="clock-container" class="d-flex justify-content-center align-items-center">
                <div class="time-display p-3 rounded text-center shadow-sm text-white">
                    <h2 id="current-time" class="mb-0 display-5">
                        <span id="current-date">{{ current_date }}</span> <span id="current-day">({{ current_day }})</span>
                    </h2>
                    <h4 id="current-period-display" class="my-1">{{ current_period_text }}</h4>
                </div>
            </div>
        </div>
        <div class="card-body">
            <form id="attendance-form" action="{{ url_for('attendance') }}" method="POST" class="mt-3">
                <div class="form-group mb-4">
                    <label for="student_id" class="form-label h4">학생 ID (학번)</label>
                    <input type="text" class="form-control form-control-lg mb-3" id="student_id" name="student_id" placeholder="학번을 입력하세요" 
                        autocomplete="off" autofocus required style="font-size: 1.5rem; height: 60px;">
                    
                    <input type="hidden" name="period" value="{{ current_period }}">
                    
                    <div id="nameDisplay" class="alert alert-info mt-2 d-none">
                        <h5 class="mb-0">이름: <span id="studentName"></span></h5>
                        <p class="mb-0">좌석: <span id="studentSeat"></span></p>
                    </div>
                    
                    {% if error %}
                    <div class="alert alert-danger">{{ error }}</div>
                    {% endif %}
                    
                    {% if success %}
                    <div class="alert alert-success">{{ success }}</div>
                    {% endif %}
                </div>
                
                <button type="button" id="confirmBtn" class="btn btn-primary btn-lg mt-3 d-none" style="font-size: 1.5rem;">
                    출석 확인
                </button>
            </form>
        </div>
        <div class="card-footer text-muted">
            <!-- 카운터 정보 -->
            {% if current_count is defined and current_count != None %}
            <div class="alert {% if current_count >= 35 %}alert-danger{% else %}alert-info{% endif %} mt-2">
                현재 교시 인원: {{ current_count }}/35명
                {% if current_count >= 35 %}
                <br><strong>최대 인원(35명)에 도달했습니다!</strong>
                {% endif %}
            </div>
            {% endif %}
        </div>
    </div>
</div>

<!-- 출석 확인 모달 -->
<div class="modal fade" id="confirmModal" tabindex="-1" aria-labelledby="confirmModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="confirmModalLabel">출석 확인</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body" id="confirmModalBody">
                <p class="lead">다음 정보로 출석을 등록합니다.</p>
                <p><strong>학번:</strong> <span id="modalStudentId"></span></p>
                <p><strong>이름:</strong> <span id="modalStudentName"></span></p>
                <p><strong>좌석:</strong> <span id="modalStudentSeat"></span></p>
                <p><strong>교시:</strong> <span id="modalPeriod"></span></p>
                <div id="warningBox" class="alert alert-warning d-none">
                    <p id="warningMessage"></p>
                </div>
                <div id="errorBox" class="alert alert-danger d-none">
                    <p id="errorMessage"></p>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">취소</button>
                <button type="button" class="btn btn-primary" id="submitConfirmBtn">확인</button>
            </div>
        </div>
    </div>
</div>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        // 학생 이름 실시간 조회
        const studentIdInput = document.getElementById('student_id');
        const nameDisplay = document.getElementById('nameDisplay');
        const studentNameSpan = document.getElementById('studentName');
        const studentSeatSpan = document.getElementById('studentSeat');
        const confirmBtn = document.getElementById('confirmBtn');
        const form = document.getElementById('attendance-form');
        
        // 모달 요소
        const modalStudentId = document.getElementById('modalStudentId');
        const modalStudentName = document.getElementById('modalStudentName');
        const modalStudentSeat = document.getElementById('modalStudentSeat');
        const modalPeriod = document.getElementById('modalPeriod');
        const submitConfirmBtn = document.getElementById('submitConfirmBtn');
        const warningBox = document.getElementById('warningBox');
        const warningMessage = document.getElementById('warningMessage');
        const errorBox = document.getElementById('errorBox');
        const errorMessage = document.getElementById('errorMessage');
        const confirmModal = new bootstrap.Modal(document.getElementById('confirmModal'));
        
        let lookupTimer;
        let currentStudentData = null;

        studentIdInput.addEventListener('input', function() {
            clearTimeout(lookupTimer);
            
            const studentId = this.value.trim();
            if (studentId.length > 4) {
                lookupTimer = setTimeout(() => {
                    fetch(`/lookup_name?student_id=${studentId}`)
                        .then(response => response.json())
                        .then(data => {
                            if (data.success && data.name) {
                                studentNameSpan.textContent = data.name;
                                studentSeatSpan.textContent = data.seat;
                                nameDisplay.classList.remove('d-none');
                                confirmBtn.classList.remove('d-none');
                                
                                // 학생 데이터 저장
                                currentStudentData = {
                                    id: studentId,
                                    name: data.name,
                                    seat: data.seat
                                };
                            } else {
                                nameDisplay.classList.add('d-none');
                                confirmBtn.classList.add('d-none');
                                currentStudentData = null;
                            }
                        })
                        .catch(error => {
                            console.error('학생 정보 조회 오류:', error);
                            nameDisplay.classList.add('d-none');
                            confirmBtn.classList.add('d-none');
                            currentStudentData = null;
                        });
                }, 300);
            } else {
                nameDisplay.classList.add('d-none');
                confirmBtn.classList.add('d-none');
                currentStudentData = null;
            }
        });
        
        // 출석 확인 버튼 클릭
        confirmBtn.addEventListener('click', function() {
            if (currentStudentData) {
                // 모달에 학생 정보 표시
                modalStudentId.textContent = currentStudentData.id;
                modalStudentName.textContent = currentStudentData.name;
                modalStudentSeat.textContent = currentStudentData.seat;
                modalPeriod.textContent = document.querySelector('input[name="period"]').value;
                
                // 이번 주 이미 출석했는지 확인
                fetch(`/check_attendance_status?student_id=${currentStudentData.id}`)
                    .then(response => response.json())
                    .then(data => {
                        console.log('학생 출석 상태 확인:', data);
                        
                        warningBox.classList.add('d-none');
                        errorBox.classList.add('d-none');
                        submitConfirmBtn.disabled = false;
                        
                        if (data.has_attendance) {
                            // 이번 주에 이미 출석한 경우
                            warningMessage.textContent = `이번주에 이미 출석하셨습니다. 4층 공강실로 올라가주세요~! (출석일: ${data.formatted_date})`;
                            warningBox.classList.remove('d-none');
                            submitConfirmBtn.disabled = true;
                        }
                        
                        // 모달 표시
                        confirmModal.show();
                    })
                    .catch(function(error) {
                        console.error('출석 상태 확인 오류:', error);
                        const errorAudio = new Audio(errorAudioBase64);
                        errorAudio.play();
                        
                        errorMessage.textContent = '출석 상태 확인 중 오류가 발생했습니다.';
                        errorBox.classList.remove('d-none');
                    });
            }
        });
        
        // 모달 확인 버튼 클릭
        submitConfirmBtn.addEventListener('click', function() {
            if (currentStudentData) {
                // 출석이 없는 경우에만 제출
                // 성공 사운드 재생
                try {
                    new Audio(successAudioBase64).play().catch(e => console.error('성공 오디오 재생 오류:', e));
                } catch(e) {
                    console.error('오디오 재생 실패:', e);
                }
                confirmModal.hide();
                form.submit();
            }
        });
        
        // 실패/오류 시 오디오 재생
        {% if error %}
        try {
            const errorAudio = new Audio(errorAudioBase64);
            errorAudio.play();
        } catch(e) {
            console.error('오디오 재생 오류:', e);
        }
        {% endif %}
        
        // 성공 시 오디오 재생
        {% if success %}
        try {
            new Audio(successAudioBase64).play().catch(e => console.error('성공 오디오 재생 오류:', e));
        } catch(e) {
            console.error('오디오 재생 실패:', e);
        }
        {% endif %}
        
        // 키보드 단축키
        document.addEventListener('keydown', function(event) {
            // Ctrl+Shift+A: 관리자 페이지
            if (event.ctrlKey && event.shiftKey && event.key === 'A') {
                window.location.href = "{{ url_for('admin_login') }}";
                event.preventDefault();
            }
        });
    });
    
    // 시계 업데이트 함수
    function updateClock() {
        const now = new Date();
        const formattedDate = now.toLocaleDateString('ko-KR', {
            month: 'long',
            day: 'numeric'
        });
        const formattedDay = now.toLocaleDateString('ko-KR', {
            weekday: 'short'
        });
        const formattedTime = now.toLocaleTimeString('ko-KR', {
            hour: '2-digit',
            minute: '2-digit',
            second: '2-digit',
            hour12: false
        });
        
        document.getElementById('current-date').textContent = formattedDate;
        document.getElementById('current-day').textContent = `(${formattedDay})`;
        
        // 시계 깜빡임 효과
        const timeDisplay = document.querySelector('.time-display');
        timeDisplay.classList.add('time-blink');
        setTimeout(() => {
            timeDisplay.classList.remove('time-blink');
        }, 500);
    }
    
    // 1초마다 시계 업데이트
    setInterval(updateClock, 1000);
    updateClock(); // 초기 시계 설정
</script>
{% endblock %}